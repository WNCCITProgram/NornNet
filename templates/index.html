{% extends 'base.html' %}

{% block title %}NornNet - Home{% endblock %}

{% block content %}
  <!-- Page container -->
  <div class="card" style="text-align:center; padding:20px;">
    <h1>NornNet</h1>
    <p>Welcome to NornNet - Where the Fates Weave Destiny with a Touch of AI Magic</p>

    <!-- Chat Interface -->
    <div id="chatbox" 
         style="border: 1px solid #ccc; background: white; padding: 10px; 
                width: 400px; height: 300px; overflow-y: auto; 
                margin: 0 auto 10px auto; text-align: left;">
    </div>

    {%- if turnstile_enabled %}
    <!-- Cloudflare Turnstile widget (AJAX flow uses callback to capture token) -->
    <div id="turnstile-container" style="margin: 10px auto; width: 400px; text-align: center;">
      <div class="cf-turnstile" data-sitekey="{{ turnstile_site_key }}" data-callback="onTurnstileSuccess"></div>
    </div>
    {%- endif %}

    <!-- User Input and Button -->
    <div style="margin-top: 10px;">
      <input type="text" id="user_input" placeholder="Ask something..." 
             style="width: 300px; padding: 8px;"
             onkeydown="if(event.key === 'Enter') sendMessage()">
      <button onclick="sendMessage()" style="padding: 8px 12px; margin-left: 5px;">Send</button>
    </div>
  </div>

  <script>

  /*
    Helper Function: getTimestamp()
    PURPOSE: Create a readable timestamp for chat messages.
    1. Create new Date() object
    2. Convert time to string format "HH:MM AM/PM".
    3. Return the formatted time.
  */

  function getTimestamp() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  /*
    Function: sendMessage()
    PURPOSE: Handles the complete process of sending the message from the user to the Flask backend
             and displaying both the user and AI messages in the chat window
    
    Features include:
      Functional sendMessage()
      Typing Indicator
      Enter Key Support
      Basic Error Handling
      Timestamp Display
      Smooth Scroll Animation
  */
  
  async function sendMessage() {
    // Capture input and chatbox references
    const userInput = document.getElementById("user_input");
    const chatbox = document.getElementById("chatbox");
    const message = userInput.value.trim();

    // Skip empty messages
    if (!message) return;

    // Display user's message + timestamp
    chatbox.innerHTML += `
      <div style="margin-bottom: 8px;">
        <strong>You:</strong> ${message}
        <div style="font-size: 0.75em; color: grey;">${getTimestamp()}</div>
      </div>`;
  
    // Clear input 
    userInput.value = "";

    // Smooth scroll to bottom
    chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });

    // Add typing indicator (user feedback while AI is responding)
    const typingIndicator = document.createElement("div");
    typingIndicator.id = "typing";
    typingIndicator.innerHTML = "<em>NornNet is weaving your fate...</em>";
    chatbox.appendChild(typingIndicator);
    chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });

    try {
      // Get selected model from dropdown
      const modelSelect = document.getElementById("model_select");
      const selectedModel = modelSelect.value;

      // If Turnstile is enabled, ensure token exists
  if (window._turnstile_token === null && {{ 'true' if turnstile_enabled else 'false' }}) {
        // No token yet
        chatbox.removeChild(typingIndicator);
        chatbox.innerHTML += `<div style="color:red; margin-bottom: 8px;"><strong>Verification required:</strong> Please complete the bot check above before sending.</div>`;
        chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });
        return;
      }

      // Send POST request to FLASK backend (/chat endpoint) with selected model
      
      /* Joe Scott 11/12/2025: I FOUND THE BUG 
       * The issue between running it locally and running it on the web is
       * that /nornnet/chat and /chat are two different things depending on
       * how you run the program. The 404 error came from the fact that the
       * route "/nornnet" does not exist locally and can only be run under
       * "/". So in summary...
       * 
       * - Website ==> fetch("/nornnet/chat")
       * - Local   ==> fetch("/chat")
       * 
       * This issue also connect to the main_app.py file on the line 110 as of now
       * 
       * Next order of business would be figuring out how we can change this
       * in the system, because no one wants to jump back and forth here.
       */

      const response = await fetch("/nornet/chat", {


        method: "POST",
        headers: { "Content-Type": "application/json"},
        body: JSON.stringify({ 
          message: message,
          model: selectedModel,  // Include selected model in request
          'cf-turnstile-response': window._turnstile_token || null
        }),
      });

      // Parse reply
      const data = await response.json();

      // Remove typing indicator
      chatbox.removeChild(typingIndicator);

      // Check if the response was successful or if validation failed
      if (!response.ok) {
        // Validation failed or other error - show error message
        chatbox.innerHTML += `
          <div style="color:red; margin-bottom: 8px;">
            <strong>Norn:</strong> ${data.reply || 'An error occurred'}
            <div style="font-size: 0.75em; color: grey;">${getTimestamp()}</div>
          </div>`;
        
        // Reset Turnstile widget so user can try again with fresh token
        if (typeof turnstile !== 'undefined') {
          const turnstileWidget = document.querySelector('.cf-turnstile');
          if (turnstileWidget) {
            turnstile.reset(turnstileWidget);
            window._turnstile_token = null;
          }
        }
        chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });
        return;
      }

      // Display AI response + timestamp
      chatbox.innerHTML += `
        <div style="margin-bottom: 8px;">
          <strong>Norn:</strong> ${data.reply}
          <div style="font-size: 0.75em; color: grey;">${getTimestamp()}</div>
        </div>`;
      
      // Smooth scroll animation to latest message
      chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });

      // Reset Turnstile widget for next message (if enabled) - only on success
      if (typeof turnstile !== 'undefined' && window._turnstile_token !== null) {
        // Find the widget ID (Turnstile assigns this automatically)
        const turnstileWidget = document.querySelector('.cf-turnstile');
        if (turnstileWidget) {
          // Reset the widget to get a fresh token for the next message
          turnstile.reset(turnstileWidget);
          window._turnstile_token = null; // Clear the token
        }
      }

    } catch (error) {
      // Handle any backend or network errors gracefully
      console.error("Chat Error:", error);
      chatbox.removeChild(typingIndicator);
      chatbox.innerHTML += `
        <div style="color:red; margin-bottom: 8px;">
          <strong>Error:</strong> Could not connect to NornNet server.
          <div style="font-size: 0.75em; color: grey;">${getTimestamp()}</div>
        </div>`;
      chatbox.scrollTo({ top: chatbox.scrollHeight, behavior: 'smooth' });  
    }
  }
  </script>

{% endblock %}